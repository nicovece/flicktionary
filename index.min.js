const express=require("express"),morgan=require("morgan"),fs=require("fs"),path=require("path"),bodyParser=require("body-parser"),uuid=require("uuid"),mongoose=require("mongoose"),dotenv=require("dotenv"),{check:check,validationResult:validationResult}=require("express-validator");dotenv.config();const app=express(),Models=require("./models.js"),Movies=Models.Movie,Users=Models.User;mongoose.connect(process.env.CONNECTION_URI);const accessLogStream=fs.createWriteStream(path.join(__dirname,"log.txt"),{flags:"a"});app.use(morgan("combined",{stream:accessLogStream})),app.use(express.static("public")),app.use(bodyParser.json()),app.use(express.urlencoded({extended:!0}));const cors=require("cors");let allowedOrigins=["http://localhost:8080","https://flicktionary.onrender.com"];app.use(cors({origin:(origin,callback)=>{if(!origin)return callback(null,!0);if(-1===allowedOrigins.indexOf(origin)){return callback(new Error("The CORS policy for this application does not allow access from origin "+origin),!1)}return callback(null,!0)}}));let auth=require("./auth")(app);const passport=require("passport");require("./passport"),app.use(((err,req,res,next)=>{console.error(err.stack),res.status(500).send("We have a problem, something gone wrong!")})),app.get("/",((req,res)=>{res.sendFile("public/index.html",{root:__dirname})})),app.get("/movies",passport.authenticate("jwt",{session:!1}),(async(req,res)=>{await Movies.find().then((movies=>{res.status(200).json(movies)})).catch((err=>{console.error(err),res.status(500).send("Error: "+err)}))})),app.get("/movies/:Title",passport.authenticate("jwt",{session:!1}),(async(req,res)=>{await Movies.findOne({Title:req.params.Title}).then((movie=>{res.json(movie)})).catch((err=>{console.error(err),res.status(500).send("Error: "+err)}))})),app.get("/movies/genre/:genreName",passport.authenticate("jwt",{session:!1}),(async(req,res)=>{await Movies.findOne({"Genre.Name":req.params.genreName}).then((movie=>{res.json(movie.Genre)})).catch((err=>{console.error(err),res.status(500).send("Error: "+err)}))})),app.get("/movies/director/:directorName",passport.authenticate("jwt",{session:!1}),(async(req,res)=>{await Movies.findOne({"Director.Name":req.params.directorName}).then((movie=>{res.json(movie.Director)})).catch((err=>{console.error(err),res.status(500).send("Error: "+err)}))})),app.get("/users",passport.authenticate("jwt",{session:!1}),(async(req,res)=>{await Users.find().then((users=>{res.status(201).json(users)})).catch((err=>{console.error(err),res.status(500).send("Error: "+err)}))})),app.get("/users/:Username",passport.authenticate("jwt",{session:!1}),(async(req,res)=>{await Users.findOne({Username:req.params.Username}).then((user=>{res.json(user)})).catch((err=>{console.error(err),res.status(500).send("Error: "+err)}))})),app.post("/users",[check("Username","Username is required and must be at least 5 characters long.").isLength({min:5}),check("Username","Username contains non alphanumeric characters - not allowed.").isAlphanumeric(),check("Email").isEmail().withMessage("Email does not have a valid format"),check("Password").isLength({min:8}).withMessage("Password must be at least 8 characters long").matches(/\d/).withMessage("Password must contain at least one number").matches(/^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[!@#$%^&*\-_=+;:,.]).{8,}$/).withMessage("Password must contain at least 8 characters, including uppercase, lowercase, numbers, and special characters")],(async(req,res)=>{let errors=validationResult(req);if(!errors.isEmpty())return res.status(422).json({errors:errors.array()});let hashedPassword=Users.hashPassword(req.body.Password);await Users.findOne({Username:req.body.Username}).then((user=>{if(user)return res.status(400).send(req.body.Username+" already exists");Users.create({Username:req.body.Username,Password:hashedPassword,Email:req.body.Email,Birthday:req.body.Birthday}).then((user=>{res.status(201).json(user)})).catch((error=>{console.error(error),res.status(500).send("Error: "+error)}))})).catch((error=>{console.error(error),res.status(500).send("Error: "+error)}))})),app.put("/users/:Username",passport.authenticate("jwt",{session:!1}),[check("Username").isLength({min:5}).withMessage("Username must be at least 5 characters long").isAlphanumeric().withMessage("Username contains non alphanumeric characters"),check("Email").optional().isEmail().withMessage("Email does not have a valid format"),check("Password").optional().isLength({min:8}).withMessage("Password must be at least 8 characters long").matches(/\d/).withMessage("Password must contain at least one number").matches(/^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[!@#$%^&*\-_=+;:,.]).{8,}$/).withMessage("Password must contain at least 8 characters, including uppercase, lowercase, numbers, and special characters")],(async(req,res)=>{if(req.user.Username!==req.params.Username&&"nicovece"!==req.user.Username)return res.status(400).send("Permission denied");let errors=validationResult(req);if(!errors.isEmpty())return res.status(422).json({errors:errors.array()});try{const updateFields={Username:req.body.Username};req.body.Email&&(updateFields.Password=req.body.Email),req.body.Password&&(updateFields.Password=Users.hashPassword(req.body.Password)),req.body.Birthday&&(updateFields.Birthday=req.body.Birthday);const updatedUser=await Users.findOneAndUpdate({Username:req.params.Username},{$set:updateFields},{new:!0});res.json(updatedUser)}catch(err){console.error(err),res.status(500).send("Error: "+err)}})),app.post("/users/:Username/movies/:MovieID",passport.authenticate("jwt",{session:!1}),(async(req,res)=>{if(req.user.Username!==req.params.Username&&"nicovece"!==req.user.Username)return res.status(400).send("Permission denied");await Users.findOneAndUpdate({Username:req.params.Username},{$push:{FavoriteMovies:req.params.MovieID}},{new:!0}).then((updatedUser=>{res.json(updatedUser)})).catch((err=>{console.error(err),res.status(500).send("Error: "+err)}))})),app.delete("/users/:Username/movies/:MovieID",passport.authenticate("jwt",{session:!1}),(async(req,res)=>{if(req.user.Username!==req.params.Username&&"nicovece"!==req.user.Username)return res.status(400).send("Permission denied");await Users.findOneAndUpdate({Username:req.params.Username},{$pull:{FavoriteMovies:req.params.MovieID}},{new:!0}).then((updatedUser=>{res.json(updatedUser)})).catch((err=>{console.error(err),res.status(500).send("Error: "+err)}))})),app.delete("/users/:Username",passport.authenticate("jwt",{session:!1}),(async(req,res)=>{if(req.user.Username!==req.params.Username&&"nicovece"!==req.user.Username)return res.status(400).send("Permission denied");await Users.findOneAndDelete({Username:req.params.Username}).then((user=>{user?res.status(200).send('User with username "'+req.params.Username+' " successfully removed.'):res.status(400).send(req.params.Username+" was not found")})).catch((err=>{console.error(err),res.status(500).send("Error: "+err)}))}));const port=process.env.PORT;app.listen(port,"0.0.0.0",(()=>{console.log("Listening on port "+port)}));